import OpenAI from 'openai';
import { config } from '../config.js';
import { SiteKnowledgeBase } from './SiteKnowledgeBase.js';
import { SiteCrawler } from './SiteCrawler.js';
import { db } from '../database/db.js';
import { HttpsProxyAgent } from 'https-proxy-agent';

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Ç–æ–º –∏ OpenAI API
 */
export class ChatService {
    constructor() {
        if (!config.openai.apiKey) {
            throw new Error('OpenAI API key is not configured');
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∫—Å–∏ –¥–ª—è OpenAI
        const openaiConfig = {
            apiKey: config.openai.apiKey,
        };
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–ø–µ—Ä–≤—ã–µ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã)
        const keyPreview = config.openai.apiKey.length > 20
            ? `${config.openai.apiKey.substring(0, 10)}...${config.openai.apiKey.substring(config.openai.apiKey.length - 10)}`
            : '***';
        console.log('üîë Using OpenAI API Key:', keyPreview);

        // –ï—Å–ª–∏ –ø—Ä–æ–∫—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if (config.proxy?.openai) {
            try {
                const proxyUrl = config.proxy.openai;
                const agent = new HttpsProxyAgent(proxyUrl, {
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è –ª—É—á—à–µ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–∫—Å–∏
                    keepAlive: true,
                    keepAliveMsecs: 1000,
                    maxSockets: 256,
                    maxFreeSockets: 256,
                    timeout: 60000,
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø—Ä–æ–∫—Å–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                    rejectUnauthorized: false // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
                });
                openaiConfig.httpAgent = agent;
                openaiConfig.httpsAgent = agent;
                // –¢–∞–∫–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏
                process.env.HTTPS_PROXY = proxyUrl;
                process.env.HTTP_PROXY = proxyUrl;
                console.log('‚úÖ OpenAI proxy configured:', proxyUrl.replace(/:[^:@]+@/, ':****@'));
            } catch (error) {
                console.error('‚ùå Error setting up OpenAI proxy:', error.message);
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –ø—Ä–æ–∫—Å–∏, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å
            }
        }

        this.openai = new OpenAI(openaiConfig);
    }

    /**
     * –î–µ–º–æ-–¥–æ–º–µ–Ω –¥–ª—è —Å—Ç–µ–Ω–¥–∞
     */
    isMarketoloDemoDomain(siteDomain) {
        if (!siteDomain) return false;
        const normalized = siteDomain.trim().toLowerCase().replace(/^https?:\/\//, '').replace(/\/.*$/, '');
        // –î–æ–±–∞–≤–ª—è–µ–º ai-studia.ru –∫–∞–∫ –¥–µ–º–æ-–¥–æ–º–µ–Ω, —Ç–∞–∫ –∫–∞–∫ —Ç–∞–º —Ä–∞–∑–º–µ—â–µ–Ω –≤–∏–¥–∂–µ—Ç
        return normalized === 'marketolo.ru' 
            || normalized === 'ai-studia.ru'
            || normalized.endsWith('.marketolo.ru')
            || normalized.endsWith('.ai-studia.ru');
    }

    /**
     * –ñ–µ—Å—Ç–∫–æ –∑–∞–¥–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –¥–µ–º–æ-–¥–æ–º–µ–Ω–∞ marketolo.ru
     * –ß—Ç–æ–±—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–ª –±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —Å–∞–π—Ç–∞.
     */
    getMarketoloContext() {
        return `[–û –ü–†–û–î–£–ö–¢–ï]
Marketolo ‚Äî –∑–∞–∫—Ä—ã—Ç—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –±–∏–∑–Ω–µ—Å–∞: —á–∞—Å—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ 350 000+ —Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–º (HNW/UHNW) –∫–ª–∏–µ–Ω—Ç–∞–º –†–æ—Å—Å–∏–∏, –≤—Å–µ —Ç–æ—á–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞.

[–ö–õ–Æ–ß–ï–í–ê–Ø –¶–ï–ù–ù–û–°–¢–¨]
- –ß–∞—Å—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –±–æ–≥–∞—Ç–µ–π—à–µ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏: –¥–æ—Ö–æ–¥—ã, —Å—Ç–∞—Ç—É—Å, –∏–Ω—Ç–µ—Ä–µ—Å—ã, –≥–µ–æ–≥—Ä–∞—Ñ–∏—è, —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è, –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–æ e-mail/—Ç–µ–ª–µ—Ñ–æ–Ω.
- –¢–æ—á–Ω—ã–µ ¬´–∫–∞—Å–∞–Ω–∏—è¬ª —Å –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π: –ø—Ä–æ–¥–∞—ë–º –∫–æ–Ω—Ç–∞–∫—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º, –∞ –Ω–µ —Ç—Ä–∞—Ñ–∏–∫.
- –ê–±—Å–æ–ª—é—Ç–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å, –±–µ–∑ ¬´—à—É–º–∞¬ª: —Ä–µ–∞–ª—å–Ω—ã–µ –ª—é–¥–∏ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–º –¥–æ—Å—Ç–∞—Ç–∫–æ–º, –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø, –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å.
- –†–µ—à–∞–µ–º –≥–ª–∞–≤–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É: —É –ø—Ä–µ–º–∏—É–º-–±–∏–∑–Ω–µ—Å–∞ –µ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç, –Ω–æ –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ –∫–∞–Ω–∞–ª–∞. Marketolo ‚Äî —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

[–î–õ–Ø –ö–û–ì–û]
- –î–µ–≤–µ–ª–æ–ø–µ—Ä—ã (—ç–ª–∏—Ç–Ω–∞—è –∏ –∑–∞—Ä—É–±–µ–∂–Ω–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, —Ä–µ–∑–∏–¥–µ–Ω—Ü–∏–∏, –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã)
- –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (—Ñ–æ–Ω–¥—ã, –±—Ä–æ–∫–µ—Ä—ã, –∑–∞–∫—Ä—ã—Ç—ã–µ –ø—É–ª—ã, —á–∞—Å—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- Private banking / —Ñ–∏–Ω–∞–Ω—Å—ã (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º, —Ç—Ä–∞—Å—Ç, family office)
- –ë–∏–∑–Ω–µ—Å—ã –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞ (–º–µ–¥–∏—Ü–∏–Ω–∞, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ, luxury-—Ç–æ–≤–∞—Ä—ã, –∫–ª—É–±—ã)

[–ß–¢–û –ü–û–õ–£–ß–ê–ï–¢ –ö–õ–ò–ï–ù–¢]
- –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ 350 000+ —Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º –†–æ—Å—Å–∏–∏
- –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º, –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏, –∞–∫—Ç–∏–≤–∞–º –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—é
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ –∏ –∫–∞—Å–∞–Ω–∏—è –ø–æ –Ω—É–∂–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏
- Performance-–º–æ–¥–µ–ª—å: –æ–ø–ª–∞—Ç–∞ –∑–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
- –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–∞—Å–∞–Ω–∏–π
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞—Ç—å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ/–¥–µ–≤–µ–ª–æ–ø–µ—Ä—Å–∫–∏–µ –ø—Ä–æ–µ–∫—Ç—ã —á–µ—Ä–µ–∑ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫

[–ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢]
1) –ö–ª–∏–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –∞—É–¥–∏—Ç–æ—Ä–∏—é –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç (–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ —Ç.–¥.).
2) Marketolo —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å–µ–≥–º–µ–Ω—Ç –∏–∑ 350 000+ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.
3) –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –∫–∞—Å–∞–Ω–∏—è: e-mail, –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã, –ø–æ–∫–∞–∑—ã, –±–∞–Ω–Ω–µ—Ä—ã, –ª–∏–¥-—Ñ–æ—Ä–º—ã.
4) –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è, –ª–∏–¥—ã –∏ —Å–¥–µ–ª–∫–∏ –æ—Ç —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
5) Marketolo –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –ø–æ–∫–∞–∑—ã.

[–ú–û–î–ï–õ–ò]
- CPC: 95 ‚ÇΩ –∑–∞ –∫–ª–∏–∫ ‚Äî –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏, –æ–ø–ª–∞—Ç–∞ —Ç–æ–ª—å–∫–æ –∑–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã.
- –ü–æ–¥ –∫–ª—é—á: 350 000 ‚ÇΩ/–º–µ—Å ‚Äî –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è + –∫–∞—Å–∞–Ω–∏—è + –∞–Ω–∞–ª–∏—Ç–∏–∫–∞.
- –ü—É–ª—ã: —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –∫—Ä–∏–ø—Ç–æ, —Ñ–∏–Ω–∞–Ω—Å—ã) ‚Äî –Ω–µ–ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è.

[–û–¢–õ–ò–ß–ò–Ø]
- –ù–µ look-alike, –∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ª—é–¥–∏.
- –ù–µ —Ö–æ–ª–æ–¥–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫, –∞ –ª—é–¥–∏ —Å –≤—ã—Å–æ–∫–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º.
- –ù–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å, –∞ —Ç–æ—á–Ω–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è.
- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —á–∞—Å—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø —Ç–∞–∫–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞ –≤ –†–æ—Å—Å–∏–∏.
- –¢–æ—á–µ—á–Ω–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤.

[–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø]
- Marketolo –Ω–µ –ø—Ä–æ–¥–∞—ë—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç –±–∞–∑—É –∫–ª–∏–µ–Ω—Ç—É.
- –î–æ—Å—Ç—É–ø –∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∏–¥—ë—Ç —á–µ—Ä–µ–∑ –∫–∞—Å–∞–Ω–∏—è Marketolo.
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –µ–≥–æ –æ—Ñ—Ñ–µ—Ä–∞.

[–ö–†–ê–¢–ö–ò–ï –§–û–†–ú–£–õ–ò–†–û–í–ö–ò –î–õ–Ø –û–¢–í–ï–¢–û–í]
‚Äî ¬´–ß–∞—Å—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ 350 000+ —Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º –†–æ—Å—Å–∏–∏¬ª
‚Äî ¬´–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º, –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏, –∞–∫—Ç–∏–≤–∞–º –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—é¬ª
‚Äî ¬´Performance-–º–æ–¥–µ–ª—å: –æ–ø–ª–∞—Ç–∞ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ; CPC 95 ‚ÇΩ¬ª
‚Äî ¬´–ü–∞–∫–µ—Ç –ø–æ–¥ –∫–ª—é—á ‚Äî 350 000 ‚ÇΩ/–º–µ—Å: –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª + –∫–∞—Å–∞–Ω–∏—è + –∞–Ω–∞–ª–∏—Ç–∏–∫–∞¬ª
‚Äî ¬´–î–æ—Å—Ç—É–ø –∫ –ø—É–ª—É –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö –∞—É–¥–∏—Ç–æ—Ä–∏–π –±–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ –±–∞–∑—ã¬ª`;
    }

    /**
     * –£—Å–∏–ª–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –¥–µ–º–æ-–¥–æ–º–µ–Ω–∞, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–≤–µ—á–∞—Ç—å ¬´–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏¬ª
     */
    buildMarketoloSystemPrompt(context) {
        return `–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ Marketolo (marketolo.ru).
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: —É–≤–µ—Ä–µ–Ω–Ω–æ –∏ –∫—Ä–∞—Ç–∫–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∞–º–∏ –∏–∑ –±–ª–æ–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∏–∂–µ.

–ì–ª–∞–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:
- –ù–µ –≥–æ–≤–æ—Ä–∏, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –ø–æ —Å—É—Ç–∏, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ —Ñ–∞–∫—Ç—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—â–∏–π (–Ω–∞–ø—Ä. ¬´–∫–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–æ–¥–∞–∂–∏¬ª, ¬´Big Data?¬ª), –æ—Ç–≤–µ—á–∞–π —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É Marketolo: —á–∞—Å—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ 350k+ HNW/UHNW –∏ —Ç–æ—á–Ω—ã–µ –∫–∞—Å–∞–Ω–∏—è.
- –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø–æ –¥–µ–ª—É, 2‚Äì5 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
- –ù–µ –æ–±–µ—â–∞–π –ø–µ—Ä–µ–¥–∞—á—É –±–∞–∑—ã –∏–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö; –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–∞—Å–∞–Ω–∏—è Marketolo.

–ö–û–ù–¢–ï–ö–°–¢:
${context}`;
    }

    /**
     * –û—Ç–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ OpenAI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –¥–µ–º–æ-–¥–æ–º–µ–Ω–µ
     */
    buildMarketoloFallbackAnswer(userMessage) {
        return `–ú—ã ‚Äî Marketolo. –ö–æ—Ä–æ—Ç–∫–æ –æ –Ω–∞—Å:
- —á–∞—Å—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ 350 000+ —Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –†–æ—Å—Å–∏–∏ (HNW/UHNW);
- —Ç–æ—á–Ω—ã–µ –∫–∞—Å–∞–Ω–∏—è: e-mail, –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã, –ø–æ–∫–∞–∑—ã, –±–∞–Ω–Ω–µ—Ä—ã, –ª–∏–¥-—Ñ–æ—Ä–º—ã;
- –º–æ–¥–µ–ª–∏: CPC 95 ‚ÇΩ/–∫–ª–∏–∫, ¬´–ø–æ–¥ –∫–ª—é—á¬ª 350 000 ‚ÇΩ/–º–µ—Å, —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É–ª—ã (–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, —Ñ–∏–Ω–∞–Ω—Å—ã, –∫—Ä–∏–ø—Ç–æ);
- –æ—Ç–ª–∏—á–∏—è: –Ω–µ look-alike, –∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ª—é–¥–∏, –±–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ –±–∞–∑—ã, –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–∞—Å–∞–Ω–∏—è.

–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ–¥—Ä–æ–±–Ω–µ–µ ‚Äî –ø–æ–¥–±–µ—Ä—ë–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç –∏ —Ñ–æ—Ä–º–∞—Ç –∫–∞—Å–∞–Ω–∏—è.`;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é —Å–∞–π—Ç–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
     */
    async ensureSiteIndexed(siteDomain) {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤/IP
        const norm = (siteDomain || '').toLowerCase();
        const isLocal =
            norm === 'localhost' ||
            norm === '127.0.0.1' ||
            norm === '0.0.0.0' ||
            /^\d+\.\d+\.\d+\.\d+$/.test(norm);
        if (isLocal) {
            return { indexing: false, status: 'skipped_local' };
        }

        const knowledgeBase = new SiteKnowledgeBase(siteDomain);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
        const status = knowledgeBase.getIndexingStatus();
        
        if (status && status.status === 'in_progress') {
            // –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è —É–∂–µ –∏–¥–µ—Ç
            return { indexing: false, status: 'in_progress' };
        }

        if (!knowledgeBase.hasIndexedPages() && config.indexing.autoIndexOnFirstRequest) {
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            console.log(`üîÑ Auto-starting indexing for ${siteDomain}`);
            this.startIndexingAsync(siteDomain);
            return { indexing: true, status: 'started' };
        }

        return { indexing: false, status: status?.status || 'completed' };
    }

    /**
     * –ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å)
     */
    async startIndexingAsync(siteDomain) {
        // –ó–∞–ø—É—Å–∫–∞–µ–º –≤ —Ñ–æ–Ω–µ
        setImmediate(async () => {
            try {
                const crawler = new SiteCrawler(siteDomain);
                await crawler.index();
            } catch (error) {
                console.error(`Error indexing ${siteDomain}:`, error);
                const stmt = db.prepare(`
                    UPDATE site_indexing_status 
                    SET status = 'error', error_message = ?, updated_at = CURRENT_TIMESTAMP
                    WHERE site_domain = ?
                `);
                stmt.run(error.message, siteDomain);
            }
        });
    }

    /**
     * –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
     */
    buildSystemPrompt(siteDomain, context) {
        return `–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏, —Ä–∞–±–æ—Ç–∞—é—â–µ–π –Ω–∞ —Å–∞–π—Ç–µ ${siteDomain}. 

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –µ—Å—Ç—å –Ω–∞ —Å–∞–π—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏.

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç ‚Äî —á–µ—Å—Ç–Ω–æ –≥–æ–≤–æ—Ä–∏ –æ–± —ç—Ç–æ–º.
2. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ü–µ–Ω–µ –∏–ª–∏ —É—Å–ª—É–≥–µ, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º –Ω–∞ —Å–∞–π—Ç–µ.
4. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º.
5. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.

–ö–û–ù–¢–ï–ö–°–¢ –û –ö–û–ú–ü–ê–ù–ò–ò:
${context || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ–∫–∞ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è. –û—Ç–≤–µ—á–∞–π –æ–±—â–∏–º–∏ —Ñ—Ä–∞–∑–∞–º–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º –Ω–∞ —Å–∞–π—Ç–µ.'}`;
    }

    /**
     * –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
     */
    limitHistory(history, maxMessages = config.knowledgeBase.maxHistoryMessages) {
        if (!history || history.length === 0) {
            return [];
        }
        
        // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π, —Å–æ—Ö—Ä–∞–Ω—è—è –ø–∞—Ä—ã user-assistant
        const limited = history.slice(-maxMessages);
        
        // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –∞ –ø–µ—Ä–≤–æ–µ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
        // —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ò–Ω–∞—á–µ –º–æ–∂–µ–º –æ–±—Ä–µ–∑–∞—Ç—å –Ω–µ–ø–æ–ª–Ω—É—é –ø–∞—Ä—É.
        return limited;
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ OpenAI –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
     */
    async getChatResponse(siteDomain, userMessage, history = []) {
        const isMarketoloDemo = this.isMarketoloDemoDomain(siteDomain);
        
        console.log(`üìù Chat request - Domain: ${siteDomain}, IsMarketoloDemo: ${isMarketoloDemo}`);

        let context = null;
        let systemPrompt = null;

        if (isMarketoloDemo) {
            // –î–ª—è –¥–µ–º–æ –Ω–µ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∫—Ä–∞—É–ª–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
            context = this.getMarketoloContext();
            systemPrompt = this.buildMarketoloSystemPrompt(context);
            console.log('‚úÖ Using Marketolo demo context');
        } else {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º/–∏–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é
            await this.ensureSiteIndexed(siteDomain);

            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
            const knowledgeBase = new SiteKnowledgeBase(siteDomain);
            context = knowledgeBase.hasIndexedPages() 
                ? knowledgeBase.buildContext(userMessage)
                : null;

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            systemPrompt = this.buildSystemPrompt(siteDomain, context);
        }

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        const limitedHistory = this.limitHistory(history);

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è OpenAI
        const messages = [
            { role: 'system', content: systemPrompt },
            ...limitedHistory,
            { role: 'user', content: userMessage },
        ];

        try {
            const completion = await this.openai.chat.completions.create({
                model: config.openai.model,
                messages: messages,
                temperature: config.openai.temperature,
                max_tokens: config.openai.maxTokens,
            });

            const assistantMessage = completion.choices[0].message.content;
            const usage = completion.usage;

            return {
                answer: assistantMessage,
                meta: {
                    usedSiteDomain: siteDomain,
                    hasContext: !!context,
                    tokens: {
                        prompt: usage.prompt_tokens,
                        completion: usage.completion_tokens,
                        total: usage.total_tokens,
                    },
                },
            };
        } catch (error) {
            console.error('OpenAI API error:', error);
            
            // –î–ª—è –¥–µ–º–æ-–¥–æ–º–µ–Ω–∞ –¥–∞–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –∫–ª—é—á/—Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
            if (isMarketoloDemo) {
                return {
                    answer: this.buildMarketoloFallbackAnswer(userMessage),
                    meta: {
                        usedSiteDomain: siteDomain,
                        hasContext: true,
                        tokens: null,
                        fallback: true,
                        error: error.message,
                    },
                };
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
            if (error.status === 429) {
                throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenAI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            } else if (error.status === 401) {
                throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á OpenAI.');
            } else if (error.code === 'ECONNABORTED' || error.code === 'ETIMEDOUT') {
                throw new Error('–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            } else {
                throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI: ${error.message}`);
            }
        }
    }
}

